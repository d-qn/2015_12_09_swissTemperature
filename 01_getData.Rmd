---
title: "monthly Swiss temperature evolution"
author: "Duc-Quang Nguyen"
date: "9 December 2015"
output: html_document
---

## Raw data

* Use the data from the different stations: [meteoSuisse](http://www.meteosuisse.admin.ch/home/climat/passe/donnees-mensuelles-homogeneisees.html?region=Tableau)
* Check computed average with [their annual data](http://www.meteosuisse.admin.ch/product/output/climate-data/homogenous-monthly-data-processing/data/homog_mo_schweiz.txt)!!


```{r, message = FALSE, echo = FALSE}
library(dplyr)
library(tidyr)
#library(ggplot2)
library(swiTheme)
```

### Settings
```{r, message = FALSE}
downloadData <- FALSE
stations <- "LUG" #c('BAS', 'BER', 'GVE')
```


### Get data of each stations
```{r}
url_stations <- c(
  "http://www.meteosuisse.admin.ch/product/output/climate-data/homogenous-monthly-data-processing/data/homog_mo_BAS.txt",
  "http://www.meteosuisse.admin.ch/product/output/climate-data/homogenous-monthly-data-processing/data/homog_mo_BER.txt",
  "http://www.meteosuisse.admin.ch/product/output/climate-data/homogenous-monthly-data-processing/data/homog_mo_CHD.txt",
  "http://www.meteosuisse.admin.ch/product/output/climate-data/homogenous-monthly-data-processing/data/homog_mo_CHM.txt",
  "http://www.meteosuisse.admin.ch/product/output/climate-data/homogenous-monthly-data-processing/data/homog_mo_DAV.txt",
  "http://www.meteosuisse.admin.ch/product/output/climate-data/homogenous-monthly-data-processing/data/homog_mo_ENG.txt",
  "http://www.meteosuisse.admin.ch/product/output/climate-data/homogenous-monthly-data-processing/data/homog_mo_GVE.txt",
  "http://www.meteosuisse.admin.ch/product/output/climate-data/homogenous-monthly-data-processing/data/homog_mo_LUG.txt", 
  "http://www.meteosuisse.admin.ch/product/output/climate-data/homogenous-monthly-data-processing/data/homog_mo_SAE.txt", 
  "http://www.meteosuisse.admin.ch/product/output/climate-data/homogenous-monthly-data-processing/data/homog_mo_SIA.txt", 
  "http://www.meteosuisse.admin.ch/product/output/climate-data/homogenous-monthly-data-processing/data/homog_mo_SIO.txt", 
  "http://www.meteosuisse.admin.ch/product/output/climate-data/homogenous-monthly-data-processing/data/homog_mo_SMA.txt"
  )
if(downloadData) {
## Download all the txt files
  sapply(url_stations, function(url) {
    download.file(url, paste0("input/", basename(url)))
  })
  cat("\n", "Swiss temperature data were downloaded")
} else {
  cat("\n", "Swiss temperature data were not downloaded")
}

# Read each txt file and save it as CSV
tables <- lapply(paste0("input/", basename(url_stations)), function(filen) {
  read.table(filen, skip = 28, stringsAsFactors = FALSE)
})
names(tables) <- gsub(".*\\_(.*)\\.txt$", "\\1", basename(url_stations))

# create a long table with year, month, temperature and station
data <- do.call(rbind, lapply(1:length(tables), function(i) {
  station <- names(tables)[i]
  cbind(tables[[i]][,1:3], station = station)
}))
colnames(data)[1:3] <- c('year', 'month', 'temp')
```


## Shape the data
```{r}
## Subset to take only the 3 western & north stations: Basel, Bern and Geneva
dd <- data %>% filter(station %in% stations)

## Compute the monthly average
df <- dd %>% group_by(year, month) %>% summarise(monthlyAverage = mean (temp, na.rm = T)) %>% ungroup()
## Compute the yearly average
df <- df %>% group_by(year) %>% mutate(yearlyAverage = mean(monthlyAverage)) %>% ungroup()

# set the month as factor
df$month <- as.factor(df$month)

# compute the average by month
average <- df %>% filter(year < 2015) %>% group_by(month) %>% 
  summarise(average = mean(monthlyAverage)) %>% ungroup()

# add a boolean column if the yearly average was hotter than the average over all years & a new cumulative max
df$hotterThanAverage <- df$yearlyAverage > mean(average$average) & df$yearlyAverage == cummax(df$yearlyAverage)

```
## Define ggplot theme and graphic parameters
```{r}
library(animation)

fontR <- "Open Sans"
fontSB <- "Open Sans Semibold"
fontL <- "Open Sans Light"
smoothAv.col <- "#8c8c8c"
yaxis.name <- "Temperature °C"
hline.size <- 0.5 


ggtheme <- function (yaxis = FALSE, base_family = fontR, base_family2 = fontSB, title_family = fontL,
    base_size = 11, axisColor = "#7E8279") 
{
    choose_font(base_family, FALSE)
    choose_font(base_family2, FALSE)
    ret <- theme_minimal(base_family = base_family, base_size = base_size) + 
        theme(
            plot.title = element_text(hjust = 0.5, vjust = 5, 
              size = rel(4), family = title_family), 
            axis.text = element_text(size = rel(1.3)), 
            axis.title = element_text(size = rel(1.6), family = base_family2, 
                color = axisColor), axis.title.x = element_text(hjust = 1, 
                vjust = -0.15), axis.title.y = element_text(vjust = 1, 
                hjust = 1), axis.line = element_line(linetype = "solid", 
                size = 0.9, color = axisColor, lineend = "round"), 
            axis.ticks = element_line(size = 0.3, color = axisColor), 
            axis.ticks.length = unit(2.5, "mm"), 
            plot.margin = unit(c(1, 2.5, 0.3, 0.5), "cm"), 
            panel.grid = element_blank()
          )
    ret
}


```

## Plot test
```{r}
## Get global plot settings
y.range <- range(df$monthlyAverage)
yAverage.range <- range(df$yearlyAverage)

# define colors
ncol.breaks <- 9
cpal <- colorRampPalette(colors = c("#69b8c9", "#c9696a"))
df$colorGroup <- cut(df$yearlyAverage, breaks = ncol.breaks)
group.colors <- structure(cpal(nlevels(df$colorGroup)), names = levels(df$colorGroup))

#ggplot(data = df) + geom_line(aes(month, monthlyAverage, group = year, colour = yearlyAverage), size = 0.1, alpha = 0.8) 

saveGIF({ 
   # add average overall smoothed curved
  bg.p1 <- ggplot() +  
      geom_smooth(data = average, aes(month, average, group = 1), 
        size = 2.5, se = F, alpha = 0.2, color = smoothAv.col) +
        ggtheme() + scale_y_continuous(limits = y.range, expand = c(0, 0), name = yaxis.name) + 
        scale_x_discrete(expand = c(0, 0)) + ggtitle("")
  bg.p2 <- bg.p1 + geom_text(data = data.frame(x = 6.5, y = 23, 
    label = "Historical monthly average: 1864-2014"), size = 6,
    aes(x = x,y = y,label = label), family = fontSB, hjust = 0.5, color = smoothAv.col)
   print(bg.p2) 
   bg.p3 <- bg.p2 + geom_hline(yintercept = mean(average$average),
        linetype = 2, alpha = 0.9, color = smoothAv.col) 
   print(bg.p3)
   bg.p4 <- bg.p3 + 
    geom_text(data = data.frame(x = 1, y = mean(average$average), 
      label = paste0(" ", "average 1864-2014: ", formatC(mean(average$average), digits = 3), "°C")), 
      size = 3.5, color = smoothAv.col,
      aes(x = x,y = y,label = label), family = fontR, hjust =  0, vjust = 1.4)
  
   invisible(sapply(1:6, function(i) print(bg.p4)))
    
   bg.p <- bg.p1 + 
    geom_hline(yintercept = mean(average$average),
      linetype = 2, alpha = 0.5, color = smoothAv.col) + 
    geom_text(data = data.frame(x = 1, y = mean(average$average), 
      label = paste0(" ", "average 1864-2014: ", formatC(mean(average$average), digits = 3), "°C")), 
      size = 3.5, color = smoothAv.col, alpha = 0.6,
      aes(x = x,y = y,label = label), family = fontR, hjust =  0, vjust = 1.4)
  print(bg.p)
     
  ## 1. animation by year
  sapply(unique(df$year), function(y) {
    cat("\n", y)
    ddd <- filter(df, year == y)
    # background : past years
    p1 <- bg.p + 
      geom_line(data = df %>% filter(year < y, hotterThanAverage == FALSE),
      aes(month, monthlyAverage, group = year, colour = colorGroup), size = 0.3, alpha = 0.2) + scale_color_manual(values = group.colors) + guides(color = "none")
      
    # background : the last year hotter than the average
    temp.max <- df %>% filter(year < y, hotterThanAverage == TRUE) %>% group_by(year, colorGroup) %>% summarise(max = last(yearlyAverage)) %>% ungroup() %>% tail(1)

   # add horizontal line for the latest max yearly temp
    if(nrow(temp.max) == 0) {
      p2 <- p1
    } else {
      p2 <- p1 + 
        geom_hline(yintercept = temp.max$max, linetype = 5, alpha = 0.5, 
          colour =  as.vector(group.colors[temp.max$colorGroup])) + 
        geom_text(data = data.frame(x = 12, y = temp.max$max, label = paste0(formatC(temp.max$max), "° ",temp.max$year)), 
          aes(x = x, y = y, label = label), family = fontR, size = 3.5, 
          colour = as.vector(group.colors[temp.max$colorGroup]),
          hjust = 1, vjust = 1.25, alpha = 0.5)
    }
    
    main.p <- p2 + 
      geom_line(data = ddd, aes(month, monthlyAverage, group = year, colour = colorGroup), size = 1.1) + 
      ggtitle(y) +
      geom_hline(yintercept = unlist(ddd[1,'yearlyAverage']), linetype = 1, alpha = 0.5, 
        colour =  group.colors[unlist(ddd[1,'colorGroup'])])
    
    if(unique(ddd$hotterThanAverage)) {
      main.p2 <- main.p + geom_hline(yintercept = unlist(ddd[1, 'yearlyAverage']), linetype = 5, size = 1, colour = as.vector(group.colors[unlist(ddd[1, 'colorGroup'])])) + 
        geom_text(data = data.frame(x = 12, y = unlist(ddd[1, 'yearlyAverage']), label = as.character(y), stringsAsFactors = F), fontface ="bold",
                  aes(x = x, y = y, label = label), family = fontR, size = 5, colour = as.vector(group.colors[unlist(ddd[1,'colorGroup'])]),
                  hjust = 1, vjust = -0.3) + 
        geom_text(data = data.frame(x = 1, y = unlist(ddd[1, 'yearlyAverage']), label = paste0(formatC(unlist(ddd[1, 'yearlyAverage']), digits = 3), " °C"), stringsAsFactors = F), 
                  aes(x = x, y = y, label = label), family = fontR, size = 5, colour = as.vector(group.colors[unlist(ddd[1,'colorGroup'])]),
                  hjust = -0.1, vjust = -0.3)
    } else {
      main.p2 <- main.p
    }
    print(main.p2)
    if(y == 2015) sapply(1:10, function(i) print(main.p2))
  })  
}, interval = 0.5, movie.name = "swissTemperature.gif", ani.width = 640, ani.height = 800)

```
